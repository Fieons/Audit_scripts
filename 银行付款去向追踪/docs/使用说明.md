# 银行付款去向跟踪系统 - 使用说明

## 系统概述

本系统用于从序时账CSV文件中提取银付凭证，追踪资金流向，生成标准化的JSON格式输出。支持所有类型的会计分录场景（一贷一借、一贷多借、多贷一借、多贷多借）。

## 项目结构

```
银行付款去向追踪/
├── src/                      # 源代码目录
│   ├── bank_payment.py       # 主程序：银行付款去向跟踪
│   ├── ai_classifier.py      # AI分类模块：智能分类功能
│   └── payment_statistics.py # 统计分析模块：独立的统计分析
├── docs/                     # 文档目录
│   └── 使用说明.md            # 本文件
├── examples/                 # 示例数据目录
│   └── 序时账2025.1-9.csv     # 示例数据文件
├── output/                   # 输出文件目录
├── README.md                 # 项目说明
└── .gitignore               # Git忽略文件
```

## 使用步骤

### 1. 环境准备

```bash
# 进入项目目录
cd 银行付款去向追踪

# 激活虚拟环境
source ../venv/bin/activate  # Linux/Mac
# 或
../venv/Scripts/activate     # Windows

# 安装依赖（如果需要）
pip install requests
```

### 2. 配置API密钥

编辑 `src/bank_payment.py` 文件，设置您的LLM API密钥：

```python
# LLM API密钥配置
llm_api_key = "your_api_key_here"  # 设置您的API密钥
llm_provider = "deepseek"          # 支持 "deepseek", "openai" 等
```

### 3. 运行主程序（银行付款去向跟踪）

```bash
cd src
python bank_payment.py
```

**功能：**
- 从序时账CSV文件中提取银付凭证
- 支持所有会计分录场景的处理
- 使用LLM进行智能分类（需要API密钥）
- 生成标准化的付款记录JSON文件

**输出文件：**
- `output/银行付款去向跟踪结果.json` - 包含所有付款记录

### 4. 运行统计分析（可选）

```bash
cd src
python payment_statistics.py
```

**功能：**
- 基于主程序生成的JSON文件进行统计分析
- 生成多维度统计报告
- 支持按用途、现金流量、账户、月份等维度分析

**输出文件：**
- `output/银行付款统计分析结果.json` - 详细的统计分析报告

## 配置说明

### API密钥配置

在 `src/bank_payment.py` 的主函数中配置LLM API密钥：

```python
# LLM API密钥配置
llm_api_key = "your_api_key_here"  # 设置您的API密钥
llm_provider = "deepseek"          # 支持 "deepseek", "openai" 等
```

### 文件路径配置

程序已预配置了相对路径：

```python
# 文件路径
csv_file = '../examples/序时账2025.1-9.csv'        # 输入的序时账文件
json_output = '../output/银行付款去向跟踪结果.json'  # 输出的付款记录文件
```

### 支持的LLM提供商

- **DeepSeek**：默认推荐，性价比高
- **OpenAI**：GPT模型，质量稳定
- 其他兼容OpenAI API的提供商

## 支持的会计分录场景

### 1. 一贷一借
- 银行存款 → 管理费用
- 生成1条付款记录

### 2. 一贷多借
- 银行存款 → 管理费用 + 销售费用 + 办公费
- 生成1条付款记录，资金分配到多个借方科目

### 3. 多贷一借
- 银行存款 + 现金 → 固定资产
- 生成2条付款记录，每个贷方对应一条付款记录

### 4. 多贷多借
- 工行存款 + 建行存款 → 原材料A + 原材料B
- 智能分配算法，确保借贷平衡

## 输出格式说明

### 付款记录格式

```json
{
  "付款ID": "11月10日-银付001-分录1",
  "原始凭证": "11月10日-银付001",
  "凭证类型": "一贷一借",
  "贷方": {
    "科目名称": "银行存款-工商银行",
    "金额": 1000.00,
    "摘要": "支付办公费",
    "银行账户": "工商银行1234"
  },
  "借方": [
    {
      "科目名称": "管理费用-办公费",
      "金额": 1000.00,
      "摘要": "购买办公用品",
      "部门": "行政部",
      "客商": "",
      "人员": "",
      "款项用途分类": "办公费",
      "现金流量表项目分类": "经营活动-支付其他与经营活动有关的现金"
    }
  ],
  "校验信息": {
    "借方合计": 1000.00,
    "贷方合计": 1000.00,
    "平衡状态": "平衡"
  }
}
```

### 统计报告格式

统计报告包含以下维度：
- **基础统计**：总记录数、总金额等
- **用途分类分析**：按款项用途分类统计
- **现金流量分类分析**：按现金流量表项目统计
- **月度趋势分析**：按月份分析资金流向
- **账户使用分析**：按付款账户统计
- **凭证类型分析**：按凭证复杂度统计

## 错误处理

### 常见问题

1. **API密钥未配置**
   - 错误：`LLM API密钥未配置，无法进行智能分类`
   - 解决：在main函数中设置llm_api_key

2. **数据格式错误**
   - 错误：`警告: 无法解析金额`
   - 解决：检查CSV文件中的金额格式

3. **文件不存在**
   - 错误：`加载数据失败`
   - 解决：确认CSV文件路径正确

4. **凭证不平衡**
   - 错误：`凭证不平衡：贷方合计 != 借方合计`
   - 解决：检查原始会计分录是否平衡

## 性能优化建议

1. **大批量数据处理**：
   - 对于大量数据，建议分批处理
   - 确保API调用频率在限制范围内

2. **网络环境**：
   - 确保网络连接稳定
   - API调用超时设置为10秒

3. **内存管理**：
   - 对于超大数据集，考虑流式处理
   - 及时释放不需要的数据

## 扩展开发

### 添加新的分类规则

在 `ai_classifier.py` 中修改分类逻辑：

```python
def classify_payment_purpose(self, summary, account_name, auxiliary_item):
    # 添加新的分类逻辑
    if "新类别" in summary:
        return "新分类名称"
    # ... 其他逻辑
```

### 添加新的统计维度

在 `payment_statistics.py` 中添加新的统计方法：

```python
def generate_custom_statistics(self):
    # 自定义统计逻辑
    pass
```

## 技术支持

如有问题或建议，请检查：
1. Python环境是否正确配置
2. 依赖包是否安装完整
3. API密钥是否有效
4. 输入数据格式是否正确

---

**版本信息：** v2.0
**更新日期：** 2025-11-10
**主要特性：** 支持所有会计分录场景、LLM智能分类、模块化设计