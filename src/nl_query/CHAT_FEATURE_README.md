# 聊天功能增强版使用说明

## 概述

自然语言查询工具现已增强聊天功能，允许用户基于查询需求、生成的SQL和查询结果进行多轮讨论，必要时可以修改SQL。

## 新功能特性

### 1. 聊天功能
- **查询讨论**：基于当前查询上下文进行多轮对话
- **上下文感知**：聊天自动包含查询需求、SQL、结果信息
- **富文本支持**：Markdown渲染、代码高亮、表格显示
- **历史管理**：对话历史保存和导出

### 2. 界面布局优化
- **2:1比例布局**：左侧查询功能（2/3宽度），右侧聊天功能（1/3宽度）
- **左侧分栏**：上部分查询输入和SQL生成，下部分查询结果
- **右侧聊天**：完整的聊天界面，支持消息发送和历史显示

### 3. 架构改进
- **LLM功能独立**：SQL生成和聊天使用独立的客户端
- **上下文管理**：统一的聊天上下文管理类
- **配置集中**：聊天相关配置集中管理

## 快速开始

### 启动应用
```bash
# 激活虚拟环境（如有）
source venv/Scripts/activate  # Windows
# 或
source venv/bin/activate      # Linux/Mac

# 运行应用
cd nl_query
python run_with_chat.py
```

### 或使用现有脚本
```bash
# Windows
start_nl_query.bat

# Linux/Mac
./start_nl_query.sh
```

## 使用流程

### 1. 执行查询
1. 在左侧"查询输入"区域输入自然语言查询
2. 点击"生成并执行"按钮
3. 查看生成的SQL和查询结果

### 2. 开始讨论
1. 点击"讨论此查询"按钮，将当前查询上下文加载到聊天
2. 在右侧聊天区域输入讨论内容
3. AI将基于查询上下文提供分析和建议

### 3. 聊天操作
- **发送消息**：在聊天输入框输入内容，按Enter发送
- **清空聊天**：点击"🗑️ 清空聊天"按钮
- **导出对话**：点击"📋 导出对话"按钮，保存为Markdown文件
- **复制消息**：聊天消息支持复制功能

## 聊天功能详解

### 上下文信息
聊天时自动包含以下上下文信息：
- **原始查询需求**：用户输入的自然语言
- **生成的SQL**：系统自动生成的SQL语句
- **查询结果摘要**：结果数据的简要描述
- **讨论历史**：之前的对话记录

### AI角色
聊天AI扮演审计数据分析助手的角色：
1. 帮助理解查询结果的含义和业务价值
2. 解释SQL查询的逻辑和数据关系
3. 基于查询结果提供数据分析建议
4. 回答用户关于数据的问题
5. 协助思考可能的查询优化方向

### 使用场景
1. **结果解释**："这个查询结果是什么意思？"
2. **SQL理解**："能解释一下这个SQL查询的逻辑吗？"
3. **数据分析**："基于这个结果，有什么业务洞察？"
4. **查询优化**："如何优化这个查询的性能？"
5. **数据探索**："还能从哪些角度分析这些数据？"

## 配置选项

### 环境变量配置（.env文件）
```ini
# 聊天相关配置
CHAT_MAX_HISTORY=10          # 最大对话历史轮数
CHAT_TEMPERATURE=0.7         # 聊天温度（0-1，越高越有创造性）
CHAT_MAX_TOKENS=1000         # 聊天最大token数
CONTEXT_SUMMARY_MAX_LENGTH=500  # 上下文摘要最大长度

# 原有配置保持不变
DEEPSEEK_API_KEY=your_api_key
DEEPSEEK_BASE_URL=https://api.deepseek.com/v1
DEEPSEEK_MODEL=deepseek-chat
DATABASE_PATH=../database/accounting.db
```

## 技术架构

### 文件结构
```
nl_query/
├── app.py                          # 主应用（2:1布局）
├── base_client.py                  # 基础LLM客户端
├── sql_generation_client.py        # SQL生成专用客户端
├── chat_client.py                  # 聊天专用客户端
├── chat_context.py                 # 聊天上下文管理
├── sql_generator.py                # SQL生成器（支持上下文）
├── config.py                       # 配置管理（新增聊天配置）
├── utils.py                        # 工具函数
├── database.py                     # 数据库管理
└── run_with_chat.py               # 启动脚本
```

### 核心类说明
- **BaseLLMClient**：基础LLM客户端，提供通用API调用
- **SQLGenerationClient**：SQL生成专用客户端，继承BaseLLMClient
- **ChatClient**：聊天专用客户端，支持多轮对话管理
- **ChatContext**：聊天上下文管理，同步查询状态
- **SQLGenerator**：SQL生成器，整合数据库和API

## 常见问题

### Q1: 聊天功能会增加API调用成本吗？
A: 是的，聊天功能会增加API调用。但通过以下方式优化：
- 对话历史长度限制（默认10轮）
- 上下文摘要优化，减少token使用
- 可配置的温度和token限制

### Q2: 聊天历史会保存吗？
A: 默认情况下，聊天历史只在当前Streamlit会话中保存，刷新页面后清空。未来版本可扩展为持久化存储。

### Q3: 聊天AI会直接修改SQL吗？
A: 不会。根据需求设计，聊天AI只提供修改思路和建议，用户需要手动在SQL编辑器中修改。这保持了安全性控制。

### Q4: 新布局会影响现有使用习惯吗？
A: 左侧查询功能的核心布局保持不变，只是将原来的第三列（结果）移到左侧下方。右侧新增聊天功能，不影响核心查询流程。

### Q5: 如何导出聊天记录？
A: 点击聊天区域的"📋 导出对话"按钮，可将整个对话导出为Markdown格式文件，包含上下文信息和时间戳。

## 性能优化

### 响应时间
- SQL生成：通常1-3秒
- 聊天回复：通常2-5秒
- 查询执行：取决于数据量和复杂度

### 资源使用
- 内存：对话历史有长度限制
- API调用：有请求频率限制和token限制
- 数据库连接：使用连接池管理

## 未来扩展

### 计划功能
1. **持久化存储**：聊天历史保存到数据库或文件
2. **多会话管理**：支持创建不同的对话主题
3. **协作功能**：多人讨论同一查询结果
4. **知识库集成**：集成审计知识库，提供更专业的分析
5. **智能建议**：基于聊天内容自动生成查询优化建议

### 技术优化
1. **缓存优化**：更智能的查询结果缓存
2. **性能监控**：详细的性能统计和监控
3. **错误处理**：更完善的错误恢复机制
4. **移动端适配**：优化移动设备体验

## 技术支持

如有问题或建议，请：
1. 查看日志文件：`nl_query/nl_query.log`
2. 检查配置：确保`.env`文件配置正确
3. 验证连接：运行`python test_integration_new.py`进行集成测试
4. 查阅文档：查看项目文档和代码注释

---

**版本**: 1.0.0 (聊天功能增强版)
**更新日期**: 2025-12-07
**兼容性**: 向后兼容原有查询功能