# CSV序时账转数据库项目 - 开发说明文档

## 项目概述

### 项目目标
将CSV格式的序时账（审计凭证数据）转换为科学的关系型数据库结构，建立标准化的会计凭证数据库，便于进行会计层面的分析和审计查询。

### 当前阶段
**第二阶段：数据一致性检验**（已完成）

## 一、项目结构

```
database_transformation/
├── data/                    # 原始CSV数据
│   ├── 凭证明细-和立-2024年.csv
│   ├── 凭证明细-和立-2025年（1-9月）.csv
│   ├── 凭证明细-盛翔-2024年.csv
│   └── 凭证明细-盛翔-2025年（1-9月）.csv
├── scripts/                 # 转换脚本（核心功能）
│   ├── csv_to_db.py         # 主转换脚本（已完成）
│   ├── data_cleaner.py      # 数据清洗模块（已完成）
│   ├── db_schema.py         # 数据库schema定义（已完成）
│   ├── auxiliary_parser.py  # 辅助项解析模块（已完成）
│   ├── test_basic.py        # 基本功能测试脚本（已完成）
│   └── data_consistency_checker.py  # 数据一致性检验脚本（第二阶段完成）
├── database/                # 生成的数据库
│   └── accounting.db        # SQLite数据库文件（转换后生成）
├── docs/                    # 文档
│   ├── 方案文档_v2.md       # 技术方案文档（已更新）
│   └── 开发说明文档.md      # 本开发说明文档
```

## 二、已完成的核心功能

### 1. 数据库Schema设计 ✅
**文件：** `scripts/db_schema.py`

**功能：**
- 完整的8张表结构设计（符合会计规范）
- 外键约束和级联删除设置
- 性能优化索引创建
- Schema验证和完整性检查
- 支持数据库重置和重建

**表结构：**
1. `companies` - 公司表
2. `account_books` - 账簿表
3. `account_subjects` - 会计科目表
4. `vouchers` - 凭证主表
5. `voucher_details` - 凭证明细表
6. `auxiliary_items` - 辅助项解析表
7. `projects` - 项目表（可选）
8. `suppliers_customers` - 客商表（可选）

### 2. 数据清洗模块 ✅
**文件：** `scripts/data_cleaner.py`

**功能：**
- CSV文件读取（支持utf-8-sig编码）
- 金额清理（去除千分位分隔符）
- 公司信息提取（从核算账簿名称分离）
- 凭证信息解析（类型和序号提取）
- 科目信息标准化（编码、名称、层级、类型）
- 借贷规则验证
- 数据清洗报告生成

**关键算法：**
- `clean_amount()` - 金额清理算法
- `extract_company_info()` - 公司信息提取
- `parse_subject_info()` - 科目信息解析
- `validate_accounting_rules()` - 借贷规则验证

### 3. 辅助项解析模块 ✅
**文件：** `scripts/auxiliary_parser.py`

**功能：**
- 解析`【类型：值】`格式的辅助项
- 辅助项类型标准化映射
- 批量解析和统计
- 格式验证和错误检测
- 重复项识别

**关键特性：**
- 支持多种辅助项类型（客商、项目、部门、银行账户等）
- 智能类型映射和标准化
- 完整的格式验证
- 批量处理能力

### 4. 主转换脚本 ✅
**文件：** `scripts/csv_to_db.py`

**功能：**
- 集成所有模块的完整转换流程
- 批量处理多个CSV文件
- 智能缓存避免重复插入
- 数据完整性验证
- 详细的转换报告

**转换流程：**
```
CSV文件 → 数据清洗 → 辅助项解析 → 数据规范化 → 数据库导入
```

**命令行接口：**
```bash
# 基本用法
python csv_to_db.py

# 指定数据目录和数据库路径
python csv_to_db.py --data-dir ../data --db-path ../database/accounting.db

# 重置数据库
python csv_to_db.py --reset-db

# 只验证数据库完整性
python csv_to_db.py --validate-only
```

### 5. 基本功能测试 ✅
**文件：** `scripts/test_basic.py`

**测试覆盖：**
- 数据库schema创建和验证
- 数据清洗功能测试
- 辅助项解析功能测试
- 错误处理和边界条件

## 三、技术实现特点

### 1. 架构设计
- **模块化设计**：每个功能独立模块，便于维护和测试
- **面向对象**：使用类封装相关功能
- **缓存机制**：避免数据库重复插入，提高性能
- **错误处理**：完善的异常处理和日志记录

### 2. 数据一致性保障
- **借贷平衡验证**：确保每个凭证借方总额等于贷方总额
- **外键完整性**：严格的引用完整性约束
- **数据验证**：转换过程中的多重验证
- **完整性检查**：数据库级别的完整性验证

### 3. 性能优化
- **批量处理**：按凭证分组批量插入
- **索引优化**：为查询字段创建索引
- **缓存策略**：常用数据内存缓存
- **连接管理**：合理的数据库连接管理

## 四、当前阶段成果

### ✅ 第一阶段：数据转换核心功能（已完成）
1. **完整的数据转换流水线**：从CSV到数据库的完整流程
2. **核心功能模块**：4个核心模块全部实现
3. **基本测试验证**：核心功能通过测试
4. **文档完善**：方案文档和开发文档

### ✅ 第二阶段：数据一致性检验（已完成）
1. **数据一致性检验脚本**：严格的源数据与数据库数据一致性验证
2. **金额精度保障**：只允许计算机浮点数精度误差，不允许货币层面误差
3. **全面验证覆盖**：6项一致性检查确保数据完整性
4. **问题修复**：解决了列名格式不一致等数据问题

### ✅ 技术验证通过
- 数据库schema设计合理
- 数据清洗算法正确（支持两种列名格式）
- 辅助项解析准确
- 转换流程完整
- 数据一致性验证严格

## 五、开发进度

### ✅ 第二阶段：数据一致性检验（已完成）

#### 1. 数据一致性检验脚本 ✅
**文件：** `scripts/data_consistency_checker.py`

**目标：** 确保源数据与转换后的数据绝对一致

**已完成功能：**
- CSV源数据与数据库数据的逐条对比
- 金额一致性验证（只允许计算机浮点数精度误差，不允许货币层面误差）
- 记录数量一致性检查
- 辅助项解析完整性验证
- 凭证信息一致性检查
- 科目信息一致性检查
- 借贷平衡检查

**技术实现：**
- 使用Decimal高精度计算确保金额准确性
- 支持两种列名格式（`借方-本币`/`贷方-本币`和`借-本币`/`贷-本币`）
- 详细的差异定位和问题诊断
- 严格的精度阈值（0.00000001）

#### 2. 增强的验证功能 ✅
- **凭证级验证**：每个凭证的借贷平衡验证（已在转换过程中实现）
- **科目级验证**：科目编码和使用次数一致性验证
- **数据完整性验证**：辅助项内容完整性验证
- **业务逻辑验证**：会计借贷规则验证

#### 3. 测试结果 ✅
所有4个CSV文件一致性检查通过：
- `凭证明细-和立-2024年.csv`：21,691条记录 ✓
- `凭证明细-和立-2025年（1-9月）.csv`：14,939条记录 ✓
- `凭证明细-盛翔-2024年.csv`：31,637条记录 ✓
- `凭证明细-盛翔-2025年（1-9月）.csv`：17,136条记录 ✓

### 第三阶段：扩展功能（规划中）

#### 1. 数据质量报告
- 数据完整性报告
- 数据准确性报告
- 数据一致性报告
- 建议和改进措施

#### 2. 监控和告警
- 转换过程监控
- 异常检测和告警
- 性能监控
- 日志分析

## 六、使用说明

### 环境要求
- Python 3.8+
- pandas >= 2.0.0
- sqlite3（Python内置）

### 快速开始
1. **准备环境**
```bash
cd database_transformation/scripts
# 使用项目根目录的虚拟环境
```

2. **运行基本测试**
```bash
python test_basic.py
```

3. **执行数据转换**
```bash
# 创建数据库并导入所有CSV数据
python csv_to_db.py --reset-db

# 或指定参数
python csv_to_db.py --data-dir ../data --db-path ../database/accounting.db --reset-db
```

4. **验证数据库**
```bash
python csv_to_db.py --validate-only
```

5. **检查数据一致性**
```bash
# 检查所有文件
python data_consistency_checker.py

# 检查单个文件
python data_consistency_checker.py --single-file "../data/凭证明细-和立-2024年.csv"
```

### 文件说明
- `csv_to_db.py` - 主入口文件，执行完整转换
- `data_cleaner.py` - 数据清洗，可单独测试清洗功能（支持两种列名格式）
- `auxiliary_parser.py` - 辅助项解析，可单独测试解析功能
- `db_schema.py` - 数据库管理，可单独管理数据库结构
- `test_basic.py` - 功能测试，验证核心功能
- `data_consistency_checker.py` - 数据一致性检验，验证源数据与数据库数据一致性

## 七、开发注意事项

### 1. 代码规范
- 遵循PEP 8编码规范
- 使用类型注解提高代码可读性
- 完善的文档字符串
- 合理的错误处理和日志

### 2. 数据安全
- 不修改原始CSV文件
- 转换过程可逆（通过重新转换）
- 数据验证确保准确性
- 完整的操作日志

### 3. 可维护性
- 模块化设计，职责分离
- 配置参数外部化
- 详细的日志记录
- 完整的测试覆盖

## 八、已知问题和限制

### 当前版本限制
1. **性能**：大数据量时可能需要优化
2. **内存**：全量数据加载可能占用较多内存
3. **错误恢复**：部分错误后需要重新开始
4. **进度显示**：缺少详细的进度条

### 兼容性说明
- 已测试提供的4个CSV文件格式
- 支持两种借方/贷方列名格式：`借方-本币`/`贷方-本币` 和 `借-本币`/`贷-本币`
- 假设CSV使用utf-8-sig编码
- 假设辅助项格式为`【类型：值】`
- 假设金额包含千分位分隔符

## 九、交接说明

### 给后续开发者的建议
1. **先阅读本文档**了解当前进度和架构
2. **运行测试**验证现有功能
3. **查看方案文档**理解业务需求
4. **从第三阶段开始**开发扩展功能

### 代码阅读顺序
1. `方案文档_v2.md` - 理解业务需求和技术方案
2. `db_schema.py` - 理解数据库结构
3. `data_cleaner.py` - 理解数据清洗逻辑（注意支持两种列名格式）
4. `auxiliary_parser.py` - 理解辅助项解析
5. `csv_to_db.py` - 理解完整转换流程
6. `data_consistency_checker.py` - 理解数据一致性验证逻辑
7. `test_basic.py` - 理解测试方法

### 开发环境
- 使用项目根目录的虚拟环境
- 依赖包已安装在虚拟环境中
- 测试数据在`data/`目录下
- 生成的数据库在`database/`目录下

## 十、版本信息

### 版本：v2.0（第二阶段完成）
**完成日期：** 2025-12-03

**完成内容：**
- 完整的数据转换核心功能（第一阶段）
- 数据一致性检验功能（第二阶段）
- 5个核心功能模块 + 1个检验模块
- 基本测试验证 + 数据一致性验证
- 完整的开发说明文档

**修复的问题：**
- 支持两种借方/贷方列名格式
- 解决编码问题
- 确保金额精度（只允许计算机浮点数误差）

**下一步：** 开发扩展功能（第三阶段）

---

*文档状态：第二阶段完成*
*最后更新：2025-12-03*
*文档维护：项目开发团队*