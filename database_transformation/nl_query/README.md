# 审计凭证自然语言查询工具

基于DeepSeek API的自然语言到SQL查询工具，专为审计凭证数据库设计。

## 功能特性

- **自然语言查询**: 使用中文自然语言描述查询需求
- **智能SQL生成**: 基于DeepSeek API自动生成优化的SQL语句
- **安全执行**: 严格的SQL安全性验证，防止注入攻击
- **结果可视化**: 数据表格展示和基本可视化功能
- **查询历史**: 自动保存查询历史，支持快速重用
- **示例查询**: 内置丰富的查询示例，快速上手

## 系统架构

```
┌─────────────────────────────────────────────┐
│               Web UI (Streamlit)            │
│  ┌────────────┬────────────┬────────────┐  │
│  │自然语言输入│  SQL显示   │ 查询结果   │  │
│  └────────────┴────────────┴────────────┘  │
└─────────────────────────────────────────────┘
                      │
              ┌───────▼────────┐
              │  SQL生成器      │
              │  • DeepSeek API│
              │  • 缓存管理    │
              └───────┬────────┘
                      │
          ┌───────────▼───────────┐
          │     数据库管理器       │
          │  • SQLite连接        │
          │  • 查询执行          │
          └───────────────────────┘
```

## 快速开始

### 1. 环境准备

确保已安装Python 3.9+，然后安装依赖：

```bash
pip install -r requirements.txt
```

### 2. 配置设置

复制环境变量模板文件：

```bash
cp .env.example .env
```

编辑`.env`文件，设置以下配置（注意：`.env`文件包含敏感信息，已添加到.gitignore）：

```env
# DeepSeek API配置
DEEPSEEK_API_KEY=sk-your-api-key-here
DEEPSEEK_BASE_URL=https://api.deepseek.com/v1
DEEPSEEK_MODEL=deepseek-chat

# 数据库配置
DATABASE_PATH=../database/accounting.db

# 查询配置
MAX_RESULTS=1000
QUERY_TIMEOUT=30
```

### 3. 运行应用

```bash
streamlit run app.py
```

应用将在 http://localhost:8501 启动。

## 使用指南

### 基本查询

1. 在左侧输入框输入自然语言查询，例如：
   - "查询所有公司信息"
   - "查看2024年和立公司的凭证流水"
   - "统计管理费用科目的发生额"

2. 点击"生成并执行"按钮
3. 查看右侧生成的SQL和查询结果

### 示例查询

侧边栏提供了多个示例查询，点击即可使用：

- **公司信息查询**: 获取所有公司基本信息
- **凭证流水查询**: 查看指定公司的凭证记录
- **科目余额分析**: 分析特定科目的借贷方发生额
- **大额交易检测**: 检测大额交易用于审计分析
- **部门费用分摊**: 按部门统计费用分摊比例

### 高级功能

- **仅生成SQL**: 点击"仅生成SQL"按钮，只生成SQL不执行
- **重新执行**: 对已生成的SQL可以重新执行
- **保存结果**: 将查询结果保存为JSON文件
- **导出CSV**: 将结果导出为CSV文件
- **数据可视化**: 对数值列进行简单的图表展示

## 项目结构

```
nl_query/
├── app.py              # Streamlit主应用
├── config.py           # 配置管理
├── database.py         # 数据库连接和管理
├── deepseek_client.py  # DeepSeek API客户端
├── sql_generator.py    # SQL生成器核心逻辑
├── utils.py           # 工具函数
├── requirements.txt    # 依赖列表
└── README.md          # 本文档
```

## 配置说明

### 数据库配置

- `DATABASE_PATH`: SQLite数据库文件路径
- `MAX_RESULTS`: 查询结果最大行数限制
- `QUERY_TIMEOUT`: 查询超时时间（秒）

### API配置

- `DEEPSEEK_API_KEY`: DeepSeek API密钥
- `DEEPSEEK_BASE_URL`: API基础URL
- `DEEPSEEK_MODEL`: 使用的模型名称

### 缓存配置

- `CACHE_ENABLED`: 是否启用查询缓存
- `CACHE_MAX_SIZE`: 缓存最大条目数
- `CACHE_TTL`: 缓存生存时间（秒）

### 安全配置

- `ALLOWED_SQL_KEYWORDS`: 允许的SQL关键字
- `FORBIDDEN_SQL_KEYWORDS`: 禁止的SQL关键字

## 开发指南

### 添加新的查询示例

在`database.py`的`get_query_examples()`方法中添加新的示例：

```python
{
    "title": "示例标题",
    "description": "示例描述",
    "sql": "SELECT * FROM table WHERE condition;",
    "natural_language": "对应的自然语言查询"
}
```

### 扩展数据库支持

1. 在`database.py`中修改`get_schema_info()`方法
2. 更新提示词模板以包含新的表结构信息
3. 添加相应的查询验证逻辑

### 自定义UI

1. 修改`app.py`中的布局和样式
2. 添加新的Streamlit组件
3. 扩展侧边栏功能

## 故障排除

### 常见问题

1. **API连接失败**
   - 检查API密钥是否正确
   - 确认网络连接正常
   - 验证API服务状态

2. **数据库连接失败**
   - 检查数据库文件路径
   - 确认文件权限
   - 验证数据库文件完整性

3. **SQL生成失败**
   - 检查自然语言查询是否清晰
   - 确认数据库schema信息完整
   - 查看日志获取详细错误信息

### 日志查看

应用日志保存在`nl_query.log`文件中，包含：
- 连接状态
- 查询执行详情
- 错误信息
- 性能统计

## 性能优化

### 缓存策略

- 启用查询缓存减少API调用
- 缓存schema信息避免重复查询
- 使用LRU缓存管理缓存条目

### 查询优化

- 自动添加LIMIT子句限制结果集
- 优先使用索引字段
- 优化JOIN条件和查询逻辑

### 资源管理

- 数据库连接池管理
- API请求限流控制
- 内存使用监控

## 安全考虑

### SQL注入防护

- 严格验证生成的SQL语句
- 禁止所有修改操作（INSERT/UPDATE/DELETE等）
- 参数化查询执行

### API安全

- API密钥安全存储
- 请求频率限制
- 错误信息脱敏

### 数据安全

- 查询结果访问控制
- 敏感数据脱敏处理
- 日志信息加密

## 后续开发计划

### 短期计划
- [ ] 添加更多查询示例
- [ ] 优化提示词工程
- [ ] 增强结果可视化

### 中期计划
- [ ] 支持多数据库类型
- [ ] 添加用户认证系统
- [ ] 实现批量查询处理

### 长期计划
- [ ] 集成其他大模型
- [ ] 添加自然语言分析报告
- [ ] 移动端适配

## 许可证

本项目基于MIT许可证开源。

## 贡献指南

欢迎提交Issue和Pull Request！

1. Fork项目
2. 创建功能分支
3. 提交更改
4. 推送到分支
5. 创建Pull Request

## 联系方式

如有问题或建议，请通过Issue反馈。