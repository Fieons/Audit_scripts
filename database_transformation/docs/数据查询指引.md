# 审计凭证数据库查询指引

## 数据库概述

本数据库包含5家公司的财务凭证数据（2023-2025年），涵盖140,854条凭证明细、26,082个凭证、293,915个辅助项。

### 数据库文件位置
- `database/accounting.db` - SQLite数据库文件

### 连接数据库
```python
import sqlite3
conn = sqlite3.connect('database/accounting.db')
cursor = conn.cursor()
```

## 数据表结构

### 1. 核心表关系图
```
companies (公司表)
    ├── account_books (账簿表)
    │       └── vouchers (凭证主表)
    │               └── voucher_details (凭证明细表)
    │                       └── auxiliary_items (辅助项表)
    ├── projects (项目表)
    └── account_subjects (科目表) ──┐
                                    │
suppliers_customers (客商表) ───────┘
```

### 2. 详细表结构

#### companies (公司表)
| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| id | INTEGER | 主键 | 1 |
| name | VARCHAR(100) | 公司名称 | 广东和立交通养护科技有限公司 |
| code | VARCHAR(50) | 公司代码 | 广东001 |

#### account_books (账簿表)
| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| id | INTEGER | 主键 | 1 |
| company_id | INTEGER | 公司ID | 1 |
| name | VARCHAR(200) | 账簿名称 | 广东和立交通养护科技有限公司-省交院账簿类型 |

#### vouchers (凭证主表)
| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| id | INTEGER | 主键 | 1 |
| book_id | INTEGER | 账簿ID | 1 |
| voucher_number | VARCHAR(50) | 凭证号 | 转-0001 |
| voucher_type | VARCHAR(10) | 凭证类型 | 转账 |
| voucher_date | DATE | 凭证日期 | 2023-01-01 |
| year | INTEGER | 年份 | 2023 |
| month | INTEGER | 月份 | 1 |
| day | INTEGER | 日 | 1 |
| total_debit | DECIMAL(15,2) | 借方合计 | 1000.00 |
| total_credit | DECIMAL(15,2) | 贷方合计 | 1000.00 |

#### voucher_details (凭证明细表)
| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| id | INTEGER | 主键 | 1 |
| voucher_id | INTEGER | 凭证ID | 1 |
| entry_number | INTEGER | 分录号 | 1 |
| summary | TEXT | 摘要 | 支付办公用品费用 |
| subject_id | INTEGER | 科目ID | 1 |
| currency | VARCHAR(20) | 币种 | 人民币 |
| debit_amount | DECIMAL(15,2) | 借方金额 | 1000.00 |
| credit_amount | DECIMAL(15,2) | 贷方金额 | 0.00 |
| auxiliary_info | TEXT | 辅助项原始文本 | 【部门：行政部】【项目：办公费用】 |
| write_off_info | TEXT | 核销信息 | |
| settlement_info | TEXT | 结算信息 | |

#### account_subjects (科目表)
| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| id | INTEGER | 主键 | 1 |
| code | VARCHAR(20) | 科目编码 | 660201 |
| name | VARCHAR(200) | 科目名称 | 职工薪酬 |
| full_name | VARCHAR(500) | 科目全称 | 660201\管理费用\职工薪酬 |
| level | INTEGER | 科目层级 | 3 |
| subject_type | VARCHAR(20) | 科目类型 | 损益-费用 |
| normal_balance | VARCHAR(10) | 正常余额方向 | 借方 |

#### auxiliary_items (辅助项表)
| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| id | INTEGER | 主键 | 1 |
| detail_id | INTEGER | 凭证明细ID | 1 |
| item_type | VARCHAR(50) | 辅助项类型 | department |
| item_name | VARCHAR(100) | 显示类型 | 部门 |
| item_value | VARCHAR(500) | 辅助项值 | 行政部 |

#### projects (项目表)
| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| id | INTEGER | 主键 | 1 |
| project_code | VARCHAR(50) | 项目编码 | PROJ0001 |
| project_name | VARCHAR(200) | 项目名称 | 高速公路维修项目 |
| company_id | INTEGER | 公司ID | 1 |

#### suppliers_customers (客商表)
| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| id | INTEGER | 主键 | 1 |
| name | VARCHAR(200) | 客商名称 | 中国电信股份有限公司 |
| type | VARCHAR(20) | 客商类型 | 供应商 |

## 查询示例

### 基础查询

#### 1. 查询所有公司
```sql
SELECT id, name, code FROM companies ORDER BY id;
```

#### 2. 查询凭证流水（按日期倒序）
```sql
SELECT c.name as 公司, v.voucher_number as 凭证号, v.voucher_date as 日期,
       v.voucher_type as 类型, v.total_debit as 借方合计, v.total_credit as 贷方合计
FROM vouchers v
JOIN account_books ab ON v.book_id = ab.id
JOIN companies c ON ab.company_id = c.id
WHERE c.name LIKE '%和立%'  -- 可替换公司名
ORDER BY v.voucher_date DESC
LIMIT 100;
```

#### 3. 查询科目余额表
```sql
SELECT s.code as 科目编码, s.name as 科目名称, s.subject_type as 科目类型,
       SUM(vd.debit_amount) as 借方发生额, SUM(vd.credit_amount) as 贷方发生额,
       COUNT(DISTINCT v.id) as 涉及凭证数
FROM voucher_details vd
JOIN account_subjects s ON vd.subject_id = s.id
JOIN vouchers v ON vd.voucher_id = v.id
WHERE s.code LIKE '6602%'  -- 管理费用科目
GROUP BY s.code, s.name, s.subject_type
ORDER BY 借方发生额 DESC;
```

### 业务场景查询

#### 4. 项目资金流水分析
```sql
SELECT p.project_name as 项目名称, c.name as 公司,
       SUM(vd.debit_amount) as 项目借方总额, SUM(vd.credit_amount) as 项目贷方总额,
       COUNT(DISTINCT v.id) as 涉及凭证数
FROM voucher_details vd
JOIN vouchers v ON vd.voucher_id = v.id
JOIN account_books ab ON v.book_id = ab.id
JOIN companies c ON ab.company_id = c.id
JOIN auxiliary_items ai ON vd.id = ai.detail_id
JOIN projects p ON ai.item_value = p.project_name
WHERE ai.item_type = 'project'
  AND v.voucher_date BETWEEN '2024-01-01' AND '2024-12-31'  -- 时间范围
GROUP BY p.project_name, c.name
ORDER BY 项目借方总额 DESC;
```

#### 5. 供应商/客户往来分析
```sql
SELECT sc.name as 客商名称, sc.type as 客商类型, c.name as 公司,
       SUM(vd.debit_amount) as 借方总额, SUM(vd.credit_amount) as 贷方总额,
       COUNT(DISTINCT v.id) as 业务笔数,
       MIN(v.voucher_date) as 最早业务日期,
       MAX(v.voucher_date) as 最近业务日期
FROM voucher_details vd
JOIN vouchers v ON vd.voucher_id = v.id
JOIN account_books ab ON v.book_id = ab.id
JOIN companies c ON ab.company_id = c.id
JOIN auxiliary_items ai ON vd.id = ai.detail_id
JOIN suppliers_customers sc ON ai.item_value = sc.name
WHERE ai.item_type IN ('supplier_customer', 'supplier', 'customer')
  AND c.name = '广东和立交通养护科技有限公司'  -- 指定公司
GROUP BY sc.name, sc.type, c.name
ORDER BY 借方总额 DESC;
```

#### 6. 部门费用分摊分析
```sql
SELECT ai.item_value as 部门名称, c.name as 公司,
       s.name as 费用科目, SUM(vd.debit_amount) as 部门费用,
       COUNT(DISTINCT v.id) as 凭证数,
       ROUND(SUM(vd.debit_amount) * 100.0 / SUM(SUM(vd.debit_amount)) OVER (PARTITION BY c.name, s.name), 2) as 占比百分比
FROM voucher_details vd
JOIN vouchers v ON vd.voucher_id = v.id
JOIN account_subjects s ON vd.subject_id = s.id
JOIN account_books ab ON v.book_id = ab.id
JOIN companies c ON ab.company_id = c.id
JOIN auxiliary_items ai ON vd.id = ai.detail_id
WHERE ai.item_type = 'department'
  AND s.subject_type = '损益-费用'
  AND vd.debit_amount > 0
  AND v.year = 2024  -- 指定年份
GROUP BY ai.item_value, c.name, s.name
HAVING SUM(vd.debit_amount) > 10000
ORDER BY c.name, s.name, 部门费用 DESC;
```

#### 7. 员工报销明细查询
```sql
SELECT ai.item_value as 员工姓名, c.name as 公司,
       s.name as 费用科目, SUM(vd.debit_amount) as 报销金额,
       COUNT(DISTINCT v.id) as 报销次数,
       MIN(v.voucher_date) as 最早报销日期,
       MAX(v.voucher_date) as 最近报销日期
FROM voucher_details vd
JOIN vouchers v ON vd.voucher_id = v.id
JOIN account_subjects s ON vd.subject_id = s.id
JOIN account_books ab ON v.book_id = ab.id
JOIN companies c ON ab.company_id = c.id
JOIN auxiliary_items ai ON vd.id = ai.detail_id
WHERE ai.item_type = 'employee'
  AND s.name LIKE '%差旅费%'  -- 可替换其他费用类型
  AND v.voucher_date >= '2024-01-01'
GROUP BY ai.item_value, c.name, s.name
ORDER BY 报销金额 DESC;
```

#### 8. 银行账户流水分析
```sql
SELECT ai.item_value as 银行账户, c.name as 公司,
       SUM(CASE WHEN vd.debit_amount > 0 THEN vd.debit_amount ELSE 0 END) as 支出总额,
       SUM(CASE WHEN vd.credit_amount > 0 THEN vd.credit_amount ELSE 0 END) as 收入总额,
       COUNT(DISTINCT v.id) as 交易笔数,
       MIN(v.voucher_date) as 最早交易,
       MAX(v.voucher_date) as 最近交易
FROM voucher_details vd
JOIN vouchers v ON vd.voucher_id = v.id
JOIN account_books ab ON v.book_id = ab.id
JOIN companies c ON ab.company_id = c.id
JOIN auxiliary_items ai ON vd.id = ai.detail_id
WHERE ai.item_type = 'bank_account'
  AND (vd.debit_amount > 0 OR vd.credit_amount > 0)
  AND v.voucher_date BETWEEN '2024-01-01' AND '2024-12-31'
GROUP BY ai.item_value, c.name
ORDER BY 支出总额 DESC;
```

#### 9. 月度费用趋势分析
```sql
SELECT v.year as 年度, v.month as 月份, c.name as 公司,
       s.subject_type as 费用类型, s.name as 科目名称,
       SUM(vd.debit_amount) as 费用金额,
       COUNT(DISTINCT v.id) as 凭证数
FROM voucher_details vd
JOIN vouchers v ON vd.voucher_id = v.id
JOIN account_subjects s ON vd.subject_id = s.id
JOIN account_books ab ON v.book_id = ab.id
JOIN companies c ON ab.company_id = c.id
WHERE s.subject_type = '损益-费用'
  AND v.year = 2024
  AND c.name = '广东和立交通养护科技有限公司'
GROUP BY v.year, v.month, c.name, s.subject_type, s.name
ORDER BY v.year, v.month, 费用金额 DESC;
```

#### 10. 现金流量分析
```sql
SELECT
    CASE
        WHEN v.voucher_type IN ('银行付款', '现金付款') THEN '现金流出'
        WHEN v.voucher_type IN ('银行收款', '现金收款') THEN '现金流入'
        ELSE '其他'
    END as 现金流类型,
    c.name as 公司,
    s.name as 相关科目,
    SUM(vd.debit_amount + vd.credit_amount) as 现金流量,
    COUNT(DISTINCT v.id) as 交易笔数,
    GROUP_CONCAT(DISTINCT SUBSTR(v.voucher_date, 1, 7)) as 涉及月份
FROM voucher_details vd
JOIN vouchers v ON vd.voucher_id = v.id
JOIN account_subjects s ON vd.subject_id = s.id
JOIN account_books ab ON v.book_id = ab.id
JOIN companies c ON ab.company_id = c.id
WHERE v.voucher_type IN ('银行付款', '现金付款', '银行收款', '现金收款')
    AND (vd.debit_amount > 0 OR vd.credit_amount > 0)
    AND v.voucher_date BETWEEN '2024-01-01' AND '2024-12-31'
GROUP BY 现金流类型, c.name, s.name
ORDER BY 现金流量 DESC;
```

### 审计分析查询

#### 11. 大额交易检测
```sql
SELECT v.voucher_number as 凭证号, v.voucher_date as 日期, c.name as 公司,
       v.voucher_type as 类型, vd.summary as 摘要,
       vd.debit_amount as 借方金额, vd.credit_amount as 贷方金额,
       s.name as 科目名称
FROM voucher_details vd
JOIN vouchers v ON vd.voucher_id = v.id
JOIN account_subjects s ON vd.subject_id = s.id
JOIN account_books ab ON v.book_id = ab.id
JOIN companies c ON ab.company_id = c.id
WHERE (vd.debit_amount > 1000000 OR vd.credit_amount > 1000000)  -- 100万以上
    AND v.voucher_date >= '2024-01-01'
ORDER BY CASE
    WHEN vd.debit_amount > vd.credit_amount THEN vd.debit_amount
    ELSE vd.credit_amount
END DESC;
```

#### 12. 凭证完整性检查
```sql
SELECT v.voucher_number as 凭证号, v.voucher_date as 日期, c.name as 公司,
       SUM(vd.debit_amount) as 明细借方合计, v.total_debit as 凭证借方合计,
       SUM(vd.credit_amount) as 明细贷方合计, v.total_credit as 凭证贷方合计,
       ABS(SUM(vd.debit_amount) - v.total_debit) as 借方差异,
       ABS(SUM(vd.credit_amount) - v.total_credit) as 贷方差异
FROM vouchers v
JOIN voucher_details vd ON v.id = vd.voucher_id
JOIN account_books ab ON v.book_id = ab.id
JOIN companies c ON ab.company_id = c.id
GROUP BY v.id, v.voucher_number, v.voucher_date, v.total_debit, v.total_credit, c.name
HAVING ABS(SUM(vd.debit_amount) - v.total_debit) > 0.01
    OR ABS(SUM(vd.credit_amount) - v.total_credit) > 0.01;
```

#### 13. 异常摘要检测（重复摘要）
```sql
SELECT vd.summary as 摘要, COUNT(*) as 出现次数,
       GROUP_CONCAT(DISTINCT c.name) as 涉及公司,
       GROUP_CONCAT(DISTINCT v.voucher_date) as 涉及日期,
       SUM(vd.debit_amount + vd.credit_amount) as 总金额
FROM voucher_details vd
JOIN vouchers v ON vd.voucher_id = v.id
JOIN account_books ab ON v.book_id = ab.id
JOIN companies c ON ab.company_id = c.id
WHERE vd.summary IS NOT NULL AND vd.summary != ''
GROUP BY vd.summary
HAVING COUNT(*) > 5  -- 出现5次以上
ORDER BY 出现次数 DESC;
```

#### 14. 科目余额方向异常检测
```sql
SELECT s.code as 科目编码, s.name as 科目名称, s.normal_balance as 正常余额方向,
       SUM(vd.debit_amount) as 实际借方, SUM(vd.credit_amount) as 实际贷方,
       CASE
           WHEN s.normal_balance = '借方' AND SUM(vd.credit_amount) > SUM(vd.debit_amount) THEN '异常'
           WHEN s.normal_balance = '贷方' AND SUM(vd.debit_amount) > SUM(vd.credit_amount) THEN '异常'
           ELSE '正常'
       END as 余额方向检查
FROM voucher_details vd
JOIN account_subjects s ON vd.subject_id = s.id
WHERE s.normal_balance IN ('借方', '贷方')
GROUP BY s.code, s.name, s.normal_balance
HAVING 余额方向检查 = '异常';
```

### 高级分析查询

#### 15. 费用同比分析
```sql
SELECT
    c.name as 公司,
    s.name as 科目名称,
    SUM(CASE WHEN v.year = 2023 THEN vd.debit_amount ELSE 0 END) as 2023年费用,
    SUM(CASE WHEN v.year = 2024 THEN vd.debit_amount ELSE 0 END) as 2024年费用,
    SUM(CASE WHEN v.year = 2025 THEN vd.debit_amount ELSE 0 END) as 2025年费用,
    ROUND((SUM(CASE WHEN v.year = 2024 THEN vd.debit_amount ELSE 0 END) -
           SUM(CASE WHEN v.year = 2023 THEN vd.debit_amount ELSE 0 END)) * 100.0 /
          NULLIF(SUM(CASE WHEN v.year = 2023 THEN vd.debit_amount ELSE 0 END), 0), 2) as 同比增减百分比
FROM voucher_details vd
JOIN vouchers v ON vd.voucher_id = v.id
JOIN account_subjects s ON vd.subject_id = s.id
JOIN account_books ab ON v.book_id = ab.id
JOIN companies c ON ab.company_id = c.id
WHERE s.subject_type = '损益-费用'
    AND v.year IN (2023, 2024, 2025)
GROUP BY c.name, s.name
HAVING SUM(vd.debit_amount) > 10000
ORDER BY c.name, 2024年费用 DESC;
```

#### 16. 项目进度与成本分析
```sql
SELECT p.project_name as 项目名称, c.name as 公司,
       COUNT(DISTINCT v.id) as 凭证数量,
       MIN(v.voucher_date) as 项目开始日期,
       MAX(v.voucher_date) as 项目最近日期,
       SUM(vd.debit_amount) as 累计成本,
       SUM(vd.credit_amount) as 累计收入,
       ROUND(SUM(vd.debit_amount) * 100.0 / NULLIF(SUM(vd.credit_amount), 0), 2) as 成本收入比
FROM voucher_details vd
JOIN vouchers v ON vd.voucher_id = v.id
JOIN account_books ab ON v.book_id = ab.id
JOIN companies c ON ab.company_id = c.id
JOIN auxiliary_items ai ON vd.id = ai.detail_id
JOIN projects p ON ai.item_value = p.project_name
WHERE ai.item_type = 'project'
GROUP BY p.project_name, c.name
HAVING COUNT(DISTINCT v.id) > 10  -- 至少有10个凭证
ORDER BY 累计成本 DESC;
```

## 辅助项类型说明

辅助项类型映射关系：
- `department` - 部门
- `project` - 项目
- `supplier_customer` - 客商（供应商/客户）
- `employee` - 员工
- `bank_account` - 银行账户
- `performance_dept_hl` - 绩效部门
- `business_partner` - 往来单位
- `cash_flow_item` - 现金流量项目
- `payment_item` - 款项名称

## 查询性能优化建议

1. **使用索引**：对经常查询的字段建立索引
   ```sql
   CREATE INDEX idx_vouchers_date ON vouchers(voucher_date);
   CREATE INDEX idx_voucher_details_subject ON voucher_details(subject_id);
   CREATE INDEX idx_auxiliary_items_type ON auxiliary_items(item_type);
   ```

2. **限制结果集**：使用`LIMIT`子句限制返回行数

3. **避免全表扫描**：在WHERE子句中使用索引字段

4. **分批处理**：对于大数据量查询，使用分页查询
   ```sql
   SELECT * FROM vouchers ORDER BY id LIMIT 1000 OFFSET 0;
   ```

## 常见问题排查

### 1. 查询结果为空
- 检查表名和字段名拼写
- 检查连接条件是否正确
- 检查WHERE条件是否过于严格

### 2. 查询性能慢
- 检查是否缺少索引
- 减少返回的列数
- 添加合适的WHERE条件限制数据量

### 3. 数据不一致
- 检查凭证借贷是否平衡（使用查询12）
- 检查科目引用完整性（使用查询14）

## 数据更新说明

数据库已包含以下公司的2023-2025年数据：
1. 广东和立交通养护科技有限公司
2. 广东和立交通养护科技有限公司-省交院账簿类型
3. 广东和立交通养护科技有限公司佛山分公司
4. 广东盛翔交通工程检测有限公司
5. 广东盛翔交通工程检测有限公司江门分公司

数据最后更新：2025年9月30日

---

*本指引基于实际数据库结构和测试查询编写，可根据具体业务需求调整查询条件。*