# CSV序时账转数据库方案文档

## 1. 项目概述

### 1.1 项目背景
将CSV格式的序时账（审计凭证数据）转换为科学的关系型数据库结构，便于进行会计层面的分析和审计查询。

### 1.2 数据来源
- 位置：`database_transformation/data/`
- 文件：
  - `凭证明细-和立-2024年.csv`
  - `凭证明细-和立-2025年（1-9月）.csv`
  - `凭证明细-盛翔-2024年.csv`
  - `凭证明细-盛翔-2025年（1-9月）.csv`

### 1.3 预期成果
- 建立标准化的会计凭证数据库
- 支持复杂的会计分析和审计查询
- 提供数据完整性和一致性验证
- 便于后续扩展和维护

## 2. 现有数据分析

### 2.1 CSV文件结构
**字段列表（共14个字段）：**
1. `月` - 月份（1-12）
2. `日` - 日期（1-31）
3. `核算账簿名称` - 公司+账簿类型（如"广东和立交通养护科技有限公司-省交院账簿类型"）
4. `凭证号` - 凭证编号（格式：类型-序号，如"银付-0001"、"转-0001"）
5. `分录号` - 分录序号（从1开始）
6. `摘要` - 业务摘要说明
7. `科目编码` - 会计科目编码（如"100201"）
8. `科目名称` - 会计科目全称（如"100201\银行存款\工商银行"）
9. `辅助项` - 结构化辅助信息（格式：`【类型：值】`）
10. `币种` - 货币类型（如"人民币"）
11. `借方-本币` - 借方金额（可能包含千分位分隔符）
12. `贷方-本币` - 贷方金额（可能包含千分位分隔符）
13. `核销信息` - 核销相关信息
14. `结算信息` - 结算相关信息

### 2.2 数据特点
1. **公司信息**：包含两家公司（和立、盛翔）
2. **时间范围**：2024-2025年数据
3. **凭证类型**：银付（银行付款）、银收（银行收款）、转（转账）
4. **辅助项结构**：包含客商、项目、部门、银行账户、人员档案等信息
5. **金额格式**：包含千分位分隔符（如"542,884.60"）
6. **借贷规则**：每条记录要么有借方金额，要么有贷方金额，不会同时有值

### 2.3 数据样例
```csv
月,日,核算账簿名称,凭证号,分录号,摘要,科目编码,科目名称,辅助项,币种,借方-本币,贷方-本币,核销信息,结算信息
1,2,广东和立交通养护科技有限公司-省交院账簿类型,银付-0001,1,定期借记待清算户 扣电话费 中国电信股份有限公司广州分公司（账期：12月）,224101,224101\其他应付款\单位往来,【客商：中国电信股份有限公司广州分公司】【款项名称：无】【绩效部门hl：公司本部】,人民币,14.78,,,
1,2,广东和立交通养护科技有限公司-省交院账簿类型,银付-0001,2,定期借记待清算户 扣电话费 中国电信股份有限公司广州分公司（账期：12月）,100201,100201\银行存款\工商银行,【银行账户：中国工商银行广州东城支行5746】,人民币,,14.78,,
```

## 3. 数据库Schema设计

### 3.1 ER图（实体关系图）
```
公司表 (companies)
    |
    |--- 1:N --- 账簿表 (account_books)
                    |
                    |--- 1:N --- 凭证主表 (vouchers)
                                    |
                                    |--- 1:N --- 凭证明细表 (voucher_details)
                                                    |
                                                    |--- 1:N --- 辅助项解析表 (auxiliary_items)
                                                    |
                                                    |--- N:1 --- 会计科目表 (account_subjects)
                                                    |
                                                    |--- N:1 --- 项目表 (projects) [通过辅助项关联]
                                                    |
                                                    |--- N:1 --- 客商表 (suppliers_customers) [通过辅助项关联]
```

### 3.2 表结构详细设计

#### 3.2.1 公司表 (companies)
| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| name | VARCHAR(100) | NOT NULL | 公司名称 |
| code | VARCHAR(50) | UNIQUE | 公司代码（可后续生成） |

#### 3.2.2 账簿表 (account_books)
| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| company_id | INTEGER | FOREIGN KEY REFERENCES companies(id) | 公司ID |
| name | VARCHAR(200) | NOT NULL | 账簿名称 |

#### 3.2.3 会计科目表 (account_subjects)
| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| code | VARCHAR(20) | NOT NULL UNIQUE | 科目编码 |
| name | VARCHAR(200) | NOT NULL | 科目名称 |
| full_name | VARCHAR(500) | | 完整科目名称 |
| level | INTEGER | | 科目层级（1-多级） |
| subject_type | VARCHAR(20) | | 科目类型（资产/负债/权益/成本/损益） |
| normal_balance | VARCHAR(10) | | 正常余额方向（debit/credit） |

#### 3.2.4 凭证主表 (vouchers)
| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| book_id | INTEGER | FOREIGN KEY REFERENCES account_books(id) | 账簿ID |
| voucher_number | VARCHAR(50) | NOT NULL | 凭证号 |
| voucher_type | VARCHAR(10) | | 凭证类型（银付/银收/转） |
| voucher_date | DATE | NOT NULL | 凭证日期（由月日+年份组合） |
| year | INTEGER | NOT NULL | 年份 |
| month | INTEGER | NOT NULL | 月份 |
| day | INTEGER | NOT NULL | 日期 |
| total_debit | DECIMAL(15,2) | DEFAULT 0 | 合计借方金额 |
| total_credit | DECIMAL(15,2) | DEFAULT 0 | 合计贷方金额 |

#### 3.2.5 凭证明细表 (voucher_details)
| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| voucher_id | INTEGER | FOREIGN KEY REFERENCES vouchers(id) | 凭证ID |
| entry_number | INTEGER | NOT NULL | 分录号 |
| summary | TEXT | | 摘要 |
| subject_id | INTEGER | FOREIGN KEY REFERENCES account_subjects(id) | 科目ID |
| currency | VARCHAR(20) | | 币种 |
| debit_amount | DECIMAL(15,2) | DEFAULT 0 | 借方金额 |
| credit_amount | DECIMAL(15,2) | DEFAULT 0 | 贷方金额 |
| auxiliary_info | TEXT | | 辅助项原始文本 |
| write_off_info | TEXT | | 核销信息 |
| settlement_info | TEXT | | 结算信息 |

#### 3.2.6 辅助项解析表 (auxiliary_items)
| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| detail_id | INTEGER | FOREIGN KEY REFERENCES voucher_details(id) | 明细ID |
| item_type | VARCHAR(50) | NOT NULL | 项类型（客商/项目/部门/银行账户/人员档案等） |
| item_name | VARCHAR(100) | | 项名称 |
| item_value | VARCHAR(500) | NOT NULL | 项值 |

#### 3.2.7 项目表 (projects) - 可选
| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| project_code | VARCHAR(50) | UNIQUE | 项目编码 |
| project_name | VARCHAR(200) | NOT NULL | 项目名称 |
| company_id | INTEGER | FOREIGN KEY REFERENCES companies(id) | 公司ID |

#### 3.2.8 客商表 (suppliers_customers) - 可选
| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| name | VARCHAR(200) | NOT NULL | 客商名称 |
| type | VARCHAR(20) | | 类型（供应商/客户） |

### 3.3 外键约束
```sql
-- 账簿表外键
FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE CASCADE

-- 凭证主表外键
FOREIGN KEY (book_id) REFERENCES account_books(id) ON DELETE CASCADE

-- 凭证明细表外键
FOREIGN KEY (voucher_id) REFERENCES vouchers(id) ON DELETE CASCADE
FOREIGN KEY (subject_id) REFERENCES account_subjects(id)

-- 辅助项解析表外键
FOREIGN KEY (detail_id) REFERENCES voucher_details(id) ON DELETE CASCADE
```

## 4. 会计借贷处理方案

### 4.1 借贷方向表示
- **借方金额**：存储在`debit_amount`字段
- **贷方金额**：存储在`credit_amount`字段
- **规则**：同一分录的`debit_amount`和`credit_amount`不能同时大于0

### 4.2 会计平衡验证
#### 4.2.1 凭证级平衡
```sql
-- 每个凭证的借方总额必须等于贷方总额
SELECT voucher_id,
       SUM(debit_amount) as total_debit,
       SUM(credit_amount) as total_credit
FROM voucher_details
GROUP BY voucher_id
HAVING ABS(SUM(debit_amount) - SUM(credit_amount)) > 0.01;
```

#### 4.2.2 科目余额计算
```sql
-- 科目余额 = 借方金额 - 贷方金额
SELECT subject_id,
       SUM(debit_amount - credit_amount) as balance
FROM voucher_details
GROUP BY subject_id;
```

### 4.3 科目性质识别
根据科目编码识别科目类型：
- `1xxx`：资产类（正常余额方向：借方）
- `2xxx`：负债类（正常余额方向：贷方）
- `3xxx`：权益类（正常余额方向：贷方）
- `4xxx`：成本类（正常余额方向：借方）
- `5xxx`：损益类-收入（正常余额方向：贷方）
- `6xxx`：损益类-费用（正常余额方向：借方）

### 4.4 会计分录验证规则
```python
def validate_accounting_entry(detail):
    """
    验证会计分录的借贷规则
    """
    errors = []

    # 规则1: 借方和贷方不能同时有值
    if detail['debit_amount'] > 0 and detail['credit_amount'] > 0:
        errors.append("同一分录不能同时有借方和贷方金额")

    # 规则2: 借方和贷方不能同时为0
    if detail['debit_amount'] == 0 and detail['credit_amount'] == 0:
        errors.append("分录必须有借方或贷方金额")

    # 规则3: 金额必须为正数
    if detail['debit_amount'] < 0 or detail['credit_amount'] < 0:
        errors.append("金额不能为负数")

    return errors
```

## 5. 数据转换流程

### 5.1 整体流程图
```
CSV文件 → 数据清洗 → 辅助项解析 → 数据规范化 → 数据库导入
```

### 5.2 数据清洗步骤
1. **读取CSV**：使用pandas读取，指定编码为utf-8-sig
2. **清理金额**：去除千分位分隔符，转为浮点数
3. **处理空值**：将空字符串转为None或默认值
4. **验证数据**：检查必填字段是否完整

### 5.3 辅助项解析规则
辅助项格式：`【类型：值】`，可能包含多个项

**解析示例：**
```
原始：`【客商：中国电信股份有限公司广州分公司】【款项名称：无】【绩效部门hl：公司本部】`
解析为：
- item_type: '客商', item_value: '中国电信股份有限公司广州分公司'
- item_type: '款项名称', item_value: '无'
- item_type: '绩效部门hl', item_value: '公司本部'
```

**正则表达式：**
```python
import re

def parse_auxiliary_info(text):
    """
    解析辅助项信息
    """
    if not text:
        return []

    pattern = r'【([^：]+)：([^】]+)】'
    matches = re.findall(pattern, text)

    items = []
    for match in matches:
        item_type = match[0].strip()
        item_value = match[1].strip()
        items.append({
            'item_type': item_type,
            'item_value': item_value
        })

    return items
```

### 5.4 数据规范化处理
1. **提取公司信息**：从`核算账簿名称`中分离公司名称和账簿类型
2. **生成凭证日期**：组合`年`、`月`、`日`为完整日期
3. **识别凭证类型**：从`凭证号`中提取类型（银付/银收/转）
4. **标准化科目**：分离科目编码和名称，建立科目层级

## 6. 技术实现方案

### 6.1 技术栈
- **数据库**：SQLite（轻量级，适合审计分析）
- **编程语言**：Python 3.8+
- **主要库**：
  - pandas：数据处理
  - sqlite3：数据库操作
  - re：正则表达式解析
- **可选库**：
  - matplotlib：数据可视化
  - sqlalchemy：ORM（如需）

### 6.2 目录结构建议
```
database_transformation/
├── data/                    # 原始CSV数据
│   ├── 凭证明细-和立-2024年.csv
│   ├── 凭证明细-和立-2025年（1-9月）.csv
│   ├── 凭证明细-盛翔-2024年.csv
│   └── 凭证明细-盛翔-2025年（1-9月）.csv
├── scripts/                 # 转换脚本
│   ├── csv_to_db.py         # 主转换脚本
│   ├── data_cleaner.py      # 数据清洗模块
│   ├── db_schema.py         # 数据库schema定义
│   └── auxiliary_parser.py  # 辅助项解析模块
├── database/                # 生成的数据库
│   └── accounting.db        # SQLite数据库文件
├── docs/                    # 文档
│   └── 方案文档.md          # 本方案文档
└── requirements.txt         # 依赖包列表
```

### 6.3 关键算法说明

#### 6.3.1 金额清理算法
```python
def clean_amount(amount_str):
    """
    清理金额字符串：去除千分位分隔符，转为浮点数
    """
    if not amount_str or pd.isna(amount_str) or str(amount_str).strip() == '':
        return 0.0

    # 去除千分位逗号和空格
    cleaned = str(amount_str).replace(',', '').strip()

    try:
        return float(cleaned)
    except ValueError:
        # 记录错误，返回0
        print(f"警告：无法解析金额 '{amount_str}'")
        return 0.0
```

#### 6.3.2 公司信息提取算法
```python
def extract_company_info(book_name):
    """
    从核算账簿名称中提取公司信息和账簿类型
    """
    # 示例："广东和立交通养护科技有限公司-省交院账簿类型"
    if '-' in book_name:
        parts = book_name.split('-', 1)
        company_name = parts[0].strip()
        book_type = parts[1].strip()
    else:
        company_name = book_name
        book_type = '默认账簿'

    return {
        'company_name': company_name,
        'book_type': book_type
    }
```

## 7. 实施步骤

### 7.1 第一阶段：数据清洗与解析
1. 创建数据清洗脚本
2. 实现辅助项解析功能
3. 验证数据清洗结果
4. 输出清洗后的中间数据

### 7.2 第二阶段：数据库构建
1. 创建数据库schema
2. 建立表结构和索引
3. 设置外键约束
4. 验证数据库结构

### 7.3 第三阶段：数据导入
1. 实现CSV到数据库的转换
2. 批量插入数据
3. 验证数据完整性和一致性
4. 生成数据质量报告

### 7.4 第四阶段：数据一致性检验（已完成）
1. **数据一致性检验脚本**：`scripts/data_consistency_checker.py`
2. **检验内容**：
   - 记录数量一致性检查
   - 金额一致性验证（只允许计算机浮点数精度误差）
   - 凭证信息一致性检查
   - 科目信息一致性检查
   - 辅助项完整性检查
   - 借贷平衡检查
3. **精度要求**：货币层面误差不允许，只接受计算机浮点数精度误差（0.00000001）
4. **列名兼容**：支持两种借方/贷方列名格式（`借方-本币`/`贷方-本币`和`借-本币`/`贷-本币`）

### 7.5 第五阶段：测试与验证
1. 功能测试
2. 数据完整性测试
3. 性能测试
4. 用户验收测试

## 8. 附录

### 8.1 数据库DDL脚本
```sql
-- 公司表
CREATE TABLE companies (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,
    code VARCHAR(50) UNIQUE
);

-- 账簿表
CREATE TABLE account_books (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    company_id INTEGER NOT NULL,
    name VARCHAR(200) NOT NULL,
    FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE CASCADE
);

-- 会计科目表
CREATE TABLE account_subjects (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    code VARCHAR(20) NOT NULL UNIQUE,
    name VARCHAR(200) NOT NULL,
    full_name VARCHAR(500),
    level INTEGER,
    subject_type VARCHAR(20),
    normal_balance VARCHAR(10)
);

-- 凭证主表
CREATE TABLE vouchers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    book_id INTEGER NOT NULL,
    voucher_number VARCHAR(50) NOT NULL,
    voucher_type VARCHAR(10),
    voucher_date DATE NOT NULL,
    year INTEGER NOT NULL,
    month INTEGER NOT NULL,
    day INTEGER NOT NULL,
    total_debit DECIMAL(15,2) DEFAULT 0,
    total_credit DECIMAL(15,2) DEFAULT 0,
    FOREIGN KEY (book_id) REFERENCES account_books(id) ON DELETE CASCADE
);

-- 凭证明细表
CREATE TABLE voucher_details (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    voucher_id INTEGER NOT NULL,
    entry_number INTEGER NOT NULL,
    summary TEXT,
    subject_id INTEGER NOT NULL,
    currency VARCHAR(20),
    debit_amount DECIMAL(15,2) DEFAULT 0,
    credit_amount DECIMAL(15,2) DEFAULT 0,
    auxiliary_info TEXT,
    write_off_info TEXT,
    settlement_info TEXT,
    FOREIGN KEY (voucher_id) REFERENCES vouchers(id) ON DELETE CASCADE,
    FOREIGN KEY (subject_id) REFERENCES account_subjects(id)
);

-- 辅助项解析表
CREATE TABLE auxiliary_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    detail_id INTEGER NOT NULL,
    item_type VARCHAR(50) NOT NULL,
    item_name VARCHAR(100),
    item_value VARCHAR(500) NOT NULL,
    FOREIGN KEY (detail_id) REFERENCES voucher_details(id) ON DELETE CASCADE
);

-- 项目表（可选）
CREATE TABLE projects (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_code VARCHAR(50) UNIQUE,
    project_name VARCHAR(200) NOT NULL,
    company_id INTEGER,
    FOREIGN KEY (company_id) REFERENCES companies(id)
);

-- 客商表（可选）
CREATE TABLE suppliers_customers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(200) NOT NULL,
    type VARCHAR(20)
);

-- 创建索引
CREATE INDEX idx_account_books_company ON account_books(company_id);
CREATE INDEX idx_vouchers_book_date ON vouchers(book_id, voucher_date);
CREATE INDEX idx_vouchers_number ON vouchers(voucher_number);
CREATE INDEX idx_voucher_details_voucher ON voucher_details(voucher_id);
CREATE INDEX idx_voucher_details_subject ON voucher_details(subject_id);
CREATE INDEX idx_auxiliary_items_detail ON auxiliary_items(detail_id);
CREATE INDEX idx_auxiliary_items_type_value ON auxiliary_items(item_type, item_value);
```

### 8.2 术语解释
- **序时账**：按时间顺序记录的会计凭证流水
- **会计分录**：每笔经济业务的借贷记录
- **会计科目**：对会计要素的具体内容进行分类核算的项目
- **辅助核算**：在科目核算基础上的补充核算，如项目、部门、客商等
- **借贷记账法**：以"借"和"贷"为记账符号的复式记账方法

### 8.3 常见问题解答

**Q1: 如何处理CSV中的千分位分隔符？**
A: 在数据清洗阶段，使用字符串替换去除逗号：`amount_str.replace(',', '')`

**Q2: 辅助项中的信息如何规范化？**
A: 使用正则表达式解析`【类型：值】`格式，将相同类型的值统一标准化

**Q3: 如何保证凭证的借贷平衡？**
A: 在数据导入时进行验证，每个凭证的借方总额必须等于贷方总额（允许微小误差）

**Q4: 数据库性能如何优化？**
A: 合理设计索引，避免全表扫描，对大表考虑按时间分区

**Q5: 如何扩展新的分析功能？**
A: 基于现有的表结构，可以添加视图、存储过程或应用程序逻辑来实现新的分析需求

**Q6: 如何验证转换后的数据与源数据一致性？**
A: 使用`data_consistency_checker.py`脚本进行严格的一致性检查，包括记录数量、金额精度、凭证信息、科目信息、辅助项完整性和借贷平衡等6项检查

**Q7: 数据一致性检查的精度要求是什么？**
A: 只允许计算机浮点数精度误差（0.00000001），不允许货币层面的误差，确保财务数据的绝对准确性

**Q8: 如何处理不同CSV文件的列名格式差异？**
A: 数据清洗模块支持两种借方/贷方列名格式：`借方-本币`/`贷方-本币`和`借-本币`/`贷-本币`，自动识别并统一处理

---

*文档版本：2.1*
*最后更新：2025-12-03*
*文档状态：已更新（添加数据一致性检验内容）*